

Installation
------------

Create an application user.::

    $ adduser encyc

For some reason, setting up a virtualenv inside the `Makefile` doesn't work, so install `virtualenv`, set up a virtual env, and then activate it.::

    $ apt-get install python-virtualenv
    $ test -d /usr/local/src/env/front || virtualenv /usr/local/src/env/front
    $ source /usr/local/src/env/front/bin/activate

Clone the `encyc-front` source code, go to the install directory, and run the installer.  On a fresh Debian install this may take 10-15 minutes.::

    $ git clone https://github.com/densho/encyc-front /usr/local/src/encyc-front
    $ cd /usr/local/src/encyc-front/front
    $ make install

Edit the settings file, adding passwords and checking the locations of network resources.::

    $ vi /usr/local/src/encyc-front/front/settings.py

    # Update the following values:
    SECRET_KEY
    EMAIL_*
    STATIC_*
    MEDIA_*
    WIKIPROX_MEDIAWIKI_API_PASSWORD = 'TODO'  # MediaWiki bot account
    DANGO_HTPASSWD_USER = 'TODO'              # HTTP Auth username
    DANGO_HTPASSWD_PWD  = 'TODO'              # HTTP Auth password
    DOCSTORE_INDEX = 'encyc-dev'

Restart the application and check status.::

    $ make restart
    $ make status


Manual Update
-------------

The following instructions describe how to pull updates from the source MediaWiki.

The application needs to be able to connect directly to the source MediaWiki.  If this is a dev or stage install you may need to set up a tunnel.  `sshuttle` is installed by the Makefile.  Run the following in a separate terminal on the machine on which `encyc-front` is installed.::

    $ /usr/sbin/sshuttle --dns -r USER@HOST 192.168.0.0/24

Switch to the application user, activate the `virtualenv`, and run the Django shell.::

    $ su encyc
    $ source  /usr/local/src/env/front/bin/activate
    $ python manage.py shell

If this is a fresh install, or if you want to start over, delete the Elasticsearch index and create a new one.::

    >>> from django.conf import settings
    >>> from wikiprox import docstore
    >>> docstore.delete_index(settings.DOCSTORE_HOSTS, settings.DOCSTORE_INDEX)
    >>> docstore.create_index(settings.DOCSTORE_HOSTS, settings.DOCSTORE_INDEX)

Now you are ready to upload the DDR topics file and pull down all the published articles.::

    >>> from wikiprox import models
    >>> models.Elasticsearch().index_topics()
    >>> models.Elasticsearch().update_all()


Automatic Update
----------------

TODO cron settings.
